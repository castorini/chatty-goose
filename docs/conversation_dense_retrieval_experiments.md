# Experiments for Conversational Dense Retrieval
This is the Chatty-goose reproduction of our paper: *[Contextualized Query Embeddings for Conversational Search](https://arxiv.org/abs/2104.08707)* Sheng-Chieh Lin, Jheng-Hong Yang and Jimmy Lin. Note that, due to quey latency concern, different from our orginal paper and [CQE github](https://github.com/castorini/CQE), in this repo, we use HSW dense index; thus, the result may be slightly different.
## Data Preparation

1. Download the input query JSON files for [cast 2019](https://github.com/daltonj/treccastweb/blob/master/2019/data/evaluation/evaluation_topics_v1.0.json) and the [cast 2020](https://github.com/daltonj/treccastweb/blob/master/2019/data/evaluation/evaluation_topics_v1.0.json). These files can be found under `data/treccastweb/2019/data` and `data/treccastweb/2020`, respectively, if you cloned the submodules for this repo.

Pass your pathname to a variable. Here we use cast2020 as an example.
default:
```shell=bash
export input_query_json=./treccastweb/2020/2020_manual_evaluation_topics_v1.0.json
```

2. Download the evaluation answer files for [cast 2019](https://trec.nist.gov/data/cast/2019qrels.txt) and [cast 2020](https://trec.nist.gov/data/cast/2020qrels.txt).

## Run CQE retrieval

The following command is for CQE, but you can also run other CQR methods using `t5` or `cqe_t5_fusion` as the input to the `--experiment` flag (Currently, dense retrieval does not support HQE since it requires longer query sequence). Running the command for the first time will download the CAsT 2019 index (or whatever index is specified for the `--sparse_index` flag). It is also possible to supply a path to a local directory containing the index. Note that `--cqe_l2_threshold` is to control how text is generated by CQE for sparse search. While conducting CQE BM25 retrieval, we use defaul setting, and for CQE hybrid search, we set `--cqe_l2_threshold=12`.
### CQE BM25 Retrieval

```shell=bash
python -m experiments.run_retrieval \
      --experiment cqe \
      --sparse_index cast2019 \
      --hits 1000 \
      --qid_queries $input_query_json \
      --output ./output/cqe_bm25 \

python -m pyserini.eval.trec_eval -c -mndcg_cut.3,1 -mrecall.1000 -mmap $qrel ./output/cqe_bm25.trec
```
### CQE Dense Retrieval
```shell=bash
python -m experiments.run_retrieval \
      --experiment cqe \
      --dense_index cast2019-tct_colbert-v2-hnsw \
      --hits 1000 \
      --qid_queries $input_query_json \
      --output ./output/cqe_dpr \

python -m pyserini.eval.trec_eval -c -mndcg_cut.3,1 -mrecall.1000 -mmap $qrel ./output/cqe_dpr.trec
```
### CQE Sparse-Dense Hybrid Retrieval
```shell=bash
python -m experiments.run_retrieval \
      --experiment cqe \
      --cqe_l2_threshold 12 \
      --dense_index cast2019-tct_colbert-v2-hnsw \
      --sparse_index cast2019 \
      --hits 1000 \
      --qid_queries $input_query_json \
      --output ./output/cqe_hybrid \

python -m pyserini.eval.trec_eval -c -mndcg_cut.3,1 -mrecall.1000 -mmap $qrel ./output/cqe_hybrid.trec
```
### CQE fuse T5 Sparse-Dense Hybrid Retrieval
```shell=bash
python -m experiments.run_retrieval \
      --experiment cqe_t5_fusion \
      --cqe_l2_threshold 12 \
      --dense_index cast2019-tct_colbert-v2-hnsw \
      --sparse_index cast2019 \
      --hits 1000 \
      --qid_queries $input_query_json \
      --output ./output/cqe_t5_hybrid \

python -m pyserini.eval.trec_eval -c -mndcg_cut.3,1 -mrecall.1000 -mmap $qrel ./output/cqe_t5_hybrid.trec
```

## Evaluation results

Results for the CAsT 2019 and 2020 evaluation dataset are provided below. The results may be slightly different from the numbers reported in the paper due to implementation differences between Huggingface and SpaCy versions. As of writing, we use `spacy==2.2.4` with the English model `en_core_web_sm==2.2.5`, and `transformers==4.0.0`. Note that the Recall@1000 reported in [CQE paper]((https://arxiv.org/abs/2104.08707)) are using rel greater than 2 but in the repo, to be consistent with other previous experiments, we use rel greater than 1.

| CAsT2019    | CQE BM25 | CQE Dense Retrieval | CQE Hybrid | T5 BM25 | T5 Dense Retrieval | T5 Hybrid | CQE+T5 Hybrid Fusion |
| ----------- | :------: | :-------------: | :-------------: | :-----: | :------------: | :---------: | :----------------: |
| mAP         |  0.2059  |     0.2616      |     0.2997      | 0.2250  |     0.2512     |   0.3043    |       0.3391       |
| Recall@1000 |  0.7705  |     0.7248      |     0.7984      | 0.7392  |     0.6734     |   0.7856    |       0.8376       |
| NDCG@1      |  0.3030  |     0.5082      |     0.4971      | 0.2842  |     0.4841     |   0.5077    |       0.5318       |
| NDCG@3      |  0.2740  |     0.4924      |     0.5032      | 0.2954  |     0.4688     |   0.5065    |       0.5226       |

| CAsT2020    | CQE BM25 | CQE Dense Retrieval | CQE Hybrid | T5 BM25 | T5 Dense Retrieval | T5 Hybrid | CQE+T5 Hybrid Fusion |
| ----------- | :------: | :-------------: | :-------------: | :-----: | :------------: | :---------: | :----------------: |
| mAP         |  0.1301  |     0.2072      |     0.2400      | 0.1236  |     0.1989     |   0.2309    |       0.2495       |
| Recall@1000 |  0.6097  |     0.7008      |     0.7410      | 0.5551  |     0.6380     |   0.6983    |       0.7638       |
| NDCG@1      |  0.1875  |     0.3429      |     0.3794      | 0.1639  |     0.3538     |   0.3742    |       0.3982       |
| NDCG@3      |  0.1712  |     0.3122      |     0.3383      | 0.1620  |     0.3182     |   0.3323    |       0.3599       |

## Add canonical response
You can also add canonical response for task of CAsT2020 with the option `--add_response` to specify how many previous response to be added in the context.
```shell=bash
python -m experiments.run_retrieval \
      --experiment t5 \
      --cqe_l2_threshold 12 \
      --add_response 1 \
      --dense_index cast2019-tct_colbert-v2-hnsw \
      --sparse_index cast2019 \
      --hits 1000 \
      --qid_queries $input_query_json \
      --output ./output/t5_hybrid \

python -m pyserini.eval.trec_eval -c -mndcg_cut.3,1 -mrecall.1000 -mmap $qrel ./output/t5_hybrid.trec
```
| CAsT2020    | T5 Hybrid |
| ----------- | :----------------: |
| mAP         |       0.2333       |
| Recall@1000 |       0.6930       |
| NDCG@1      |       0.3934       |
| NDCG@3      |       0.3406       |

## Reproduction Log

